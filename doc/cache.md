# キャッシュ戦略設計

## 1. キャッシュ対象データ

### 1-1. 日別集計データ

- キャッシュキー形式: `daily_summary:{user_id}:{date}`
- 保持期間: 90日
- データ構造:
        ```json
        {
            "summary_date": "2024-02-21",
            "total_sleep_duration": 7.5,
            "avg_sleep_quality": 85.0,
            "sleep_start_time": "23:00",
            "sleep_end_time": "06:30",
            "sleep_segment_count": 1,
            "is_within_target_time": true
        }
        ```

### 1-2. 期間統計データ

- キャッシュキー形式: `period_stats:{user_id}:{period}`
- period: "30days", "60days", "90days"
- 保持期間: 24時間
- データ構造:
        ```json
        {
            "period": "90days",
            "avg_duration": 7.2,
            "avg_quality": 82.5,
            "target_achievement_rate": 85.0,
            "most_common_bedtime": "23:00",
            "most_common_waketime": "06:30"
        }
        ```

## 2. キャッシュ更新戦略

### 2-1. 日別集計データ

1. データ更新時の即時更新
   - sleep_recordsの更新時に関連する日のキャッシュを無効化
   - 集計バッチ実行後に新しい集計値でキャッシュを更新

2. バックグラウンド更新
   - 毎日0時に過去90日分のキャッシュを一括更新
   - 存在しないキャッシュへのアクセス時に動的に生成

### 2-2. 期間統計データ

1. 定期更新
   - 毎日1回、全ユーザーの期間統計を更新
   - 更新時刻: 深夜1時（日別集計の後）

2. オンデマンド更新
   - PDF出力リクエスト時に最新の統計を計算
   - 計算結果を24時間キャッシュ

## 3. キャッシュ管理

### 3-1. 容量管理

- 1ユーザーあたりの必要容量
  - 日別データ: 約1KB × 90日 = 90KB
  - 期間統計: 約2KB × 3期間 = 6KB
  - 合計: 約96KB/ユーザー

- メモリ使用量の見積もり
  - 想定ユーザー数: 10,000人
  - 必要総容量: 約960MB
  - バッファー: 40%
  - 推奨割当メモリ: 1.5GB

### 3-2. エラー処理

1. キャッシュ取得エラー時
   - DBから直接データを取得
   - バックグラウンドでキャッシュを再構築

2. キャッシュ更新エラー時
   - エラーログを記録
   - アラート通知
   - 次回の定期更新まで古いキャッシュを維持

## 4. PDF出力時の最適化

### 4-1. データアクセス

1. 90日分のデータ取得手順
   - キャッシュから日別データを一括取得
   - 欠損データのみDBから補完
   - 期間統計データを利用して概要を生成

### 4-2. パフォーマンス対策

1. バッチ取得の実装
   - MGET/MPIPELINEを使用した一括取得
   - 取得データを一時的にメモリにキャッシュ

2. 非同期更新の活用
   - PDF生成開始時に必要なキャッシュを事前確認
   - 欠損キャッシュの非同期更新をトリガー

## 5. 監視と運用

### 5-1. 監視項目

- キャッシュヒット率
- キャッシュ更新の成功率
- キャッシュデータの整合性
- メモリ使用率

### 5-2. アラート条件

- キャッシュヒット率が85%以下
- キャッシュ更新エラーが発生
- メモリ使用率が80%以上

### 5-3. 定期メンテナンス

- 週1回の整合性チェック
- 月1回のキャッシュ完全リフレッシュ
- 四半期ごとのキャッシュ設定の見直し
